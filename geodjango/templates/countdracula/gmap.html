<!doctype html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<title>Count Dracula Map</title>
<link href="{{ STATIC_URL }}countdracula.css" rel="stylesheet" type="text/css">
<script src="http://maps.google.com/maps/api/js?sensor=false"></script>
<script src="{{ STATIC_URL }}jquery-1.8.2.js"></script>
<script>
{% load jsonify %}

var turn_count_locs       = {{ turn_count_locs|jsonify }};
var mainline_count_locs   = {{ mainline_count_locs|jsonify }};
var nodes                 = {{ nodes|jsonify }};
var count_years           = {{ count_years|jsonify }};
var turnlocs_to_years     = {{ turnlocs_to_years|jsonify }};
var mainlinelocs_to_years = {{ mainlinelocs_to_years|jsonify }};


var map, infowindow = {};
var movement_markers = new Object();
var mainline_markers = new Object();

function initialize() {
  // start out with the checkboxes checked
  $(":checkbox").prop("checked", true);

  var styles = [{"stylers": [{ "saturation": -50 }]}];
  var styledMap = new google.maps.StyledMapType(styles, {name:"Styled Map"});

  map = new google.maps.Map(document.getElementById('map'), {
        zoom: 13,
        center: new google.maps.LatLng(37.76, -122.44),
        mapTypeIds: [google.maps.MapTypeId.ROADMAP, 'map_style'],
  });
  map.mapTypes.set('map_style', styledMap);
  map.setMapTypeId('map_style');
  
  infowindow = new google.maps.InfoWindow({
    content:'<div id="content">I miss Fury.</div>'
  });
    
  var marker_image = new google.maps.MarkerImage("{{ STATIC_URL }}small_red.png");

  /* Create the movement markers */
  var movement_count_loc_ids = [];
  for (var idx = 0; idx < turn_count_locs.length; idx++) {
    var id = turn_count_locs[idx].pk;
    movement_count_loc_ids.push(id);
    var node_id = turn_count_locs[idx].fields.intersection;
     
    movement_markers[id] = new Object();
    movement_markers[id].marker =  new google.maps.Marker({
      map:map,
      icon:marker_image,
      position:new google.maps.LatLng(nodes[node_id][1], nodes[node_id][0]),
      title:id.toString()
    });
    (function(i){
      google.maps.event.addListener(movement_markers[id].marker, 'click', function() { getCountsInfo("turn",i); });
    })(id);
  }
  $("input[name=movement_loc_ids]").val(movement_count_loc_ids);
  
  /* Create mainline markers */
  var mainline_count_loc_ids = [];
  for (var idx = 0; idx < mainline_count_locs.length; idx++) {
    var id = mainline_count_locs[idx].pk;
    mainline_count_loc_ids.push(id);
    var node_id_1 = mainline_count_locs[idx].fields.from_int;
    var node_id_2 = mainline_count_locs[idx].fields.to_int;
    mainline_markers[id] = new Object();
    mainline_markers[id].marker = new google.maps.Polyline({
      map:map,
      path:[new google.maps.LatLng(nodes[node_id_1][1], nodes[node_id_1][0]),
            new google.maps.LatLng(nodes[node_id_2][1], nodes[node_id_2][0])
           ],
      strokeColor:"#FF0000", strokeOpacity:0.8, strokeWeight:3,
      // title:"{{mainline_count_loc}}"
    });
    (function(i){
      google.maps.event.addListener(mainline_markers[id].marker, 'click', function() { getCountsInfo("mainline", i); });
    })(id);  
  }
  $("input[name=mainline_loc_ids]").val(mainline_count_loc_ids);

  /* Update display on GUI events */
  $(':input').change(function(){  updateDisplay(); });    
}

/* Gets called when an UI element changes.
 */
function updateDisplay() {
  console.log("updateDisplay");
  
  show_movement_locations = $("#movement").is(":checked");
  show_mainline_locations = $("#mainline").is(":checked");
  
  var checked_years = [];
  for (var idx = 0; idx < count_years.length; idx++) {
    if ($("#year"+count_years[idx]).is(":checked")) {
      checked_years.push(count_years[idx].toString());
    }
  }
  console.log(checked_years);
  var checked_vtypes = 0;
  for (var idx = 0; idx < 6; idx++) {
    if ($("#vtype"+idx).is(":checked")) {
      checked_vtypes = checked_vtypes | (1<<idx);
    }
  }
  console.log(checked_vtypes);
    
  /*************** mainline **************************/
  var mainline_count_num = 0;
  var mainline_count_loc_ids = [];  
  for (var id in mainline_markers) {
    if (show_mainline_locations == false) {
      mainline_markers[id].marker.setMap(null);
      continue;
    }
    
    var year_qualifies = false;
    var vtypes = 0; /* vtypes for the qualifying years */
    for (var year in mainlinelocs_to_years[id]) {
      if (jQuery.inArray(year, checked_years) >= 0) {
        year_qualifies = true;
        vtypes = vtypes | mainlinelocs_to_years[id][year];
      }
    }

    if (year_qualifies && (vtypes & checked_vtypes)) {
      mainline_markers[id].marker.setMap(map);
      mainline_count_num += 1;
      mainline_count_loc_ids.push(id);
    } else {
      mainline_markers[id].marker.setMap(null);
    }
  }  
  $("span#mainline_count_num").html(mainline_count_num);
  $("input[name=mainline_loc_ids]").val(mainline_count_loc_ids);
  
  /*************** movement **************************/
  var movement_count_num = 0;
  var movement_count_loc_ids = [];  
  for (var id in movement_markers) {
    if (show_movement_locations == false) {
      movement_markers[id].marker.setMap(null);
      continue;
    }
    
    var year_qualifies = false;
    var vtypes = 0; /* vtypes for the qualifying years */
    for (var year in turnlocs_to_years[id]) {
      if (jQuery.inArray(year, checked_years) >= 0) {
        year_qualifies = true;
        vtypes = vtypes | turnlocs_to_years[id][year];
      }
    }
    if (year_qualifies && (vtypes & checked_vtypes)) {
      movement_markers[id].marker.setMap(map);
      movement_count_num += 1;
      movement_count_loc_ids.push(id);
    } else {
      movement_markers[id].marker.setMap(null);
    }
  }  
  $("span#movement_count_num").html(movement_count_num);
  $("input[name=movement_loc_ids]").val(movement_count_loc_ids);  
}

/* Gets called when the information for a marker or a polyline comes back from the server,
 * and we need to display it in an info window.
 */
function showInfoWindow(json) {
  // console.log(json);
  
  var content_str = '<div class="content">';
  content_str     += json.where_str + '<br />';
  for (var period_str in json.period_minutes) {
    content_str   += json.period_minutes[period_str] + ' ' + period_str + '-minute counts<br />';
  }
  if (json.date_min == json.date_max) {
    content_str   += "collected in " + json.date_min;
  }
  else {
    content_str   += "collected between " + json.date_min + " and " + json.date_max;
  }  
  content_str     += '</div>';
  infowindow.setContent(content_str);
  
  if (json.count_type == 'turn') {
    infowindow.open(map, movement_markers[json.loc_id].marker);
  } else {
    infowindow.position = google.maps.geometry.spherical.interpolate(mainline_markers[json.loc_id].marker.getPath().getAt(0), 
                                                                     mainline_markers[json.loc_id].marker.getPath().getAt(1), 0.5);
    infowindow.open(map);
  }
}

/* Gets called when a polyline or a marker is clicked; initiates a call to the server for
 * more information about that particular count location.
 */
function getCountsInfo(type, id) {
  console.log("getCountsInfo(" + type + "," + id + ")");
  // request information on the counts available here  
  $.getJSON("/countdracula/counts_for_location/", { count_type:type, loc_id:id }, showInfoWindow );
}

$(document).ready(function () {});
</script>
<link rel="stylesheet" href="{{ STATIC_URL }}gmap.css"/>
</head>
<body onload='initialize()'>
  <div id="header"><h1>Count Dracula</h1></div>
  <div id="nav"><form name="download" action="/countdracula/download/" method="post">{% csrf_token %}
   <table id='filters'>
   <tr><th>Count Types</th>
       <td id="count-type">
       <input type="checkbox" id="movement" name="count-type" value="movement" />Movement<br />
       <input type="checkbox" id="mainline" name="count-type" value="mainline" />Mainline<br />
       </td>
   </tr>
   <tr><th>Vehicle Types</th>
       <td id="vehicle-type">
       <input type="checkbox" id="vtype0" name="vtype" value="0" />All<br />       
       <input type="checkbox" id="vtype1" name="vtype" value="1" />Pedestrian<br />       
       <input type="checkbox" id="vtype2" name="vtype" value="2" >Bike<br />       
       <input type="checkbox" id="vtype3" name="vtype" value="3" >Truck<br />       
       <input type="checkbox" id="vtype4" name="vtype" value="4" >Bus<br />       
       <input type="checkbox" id="vtype5" name="vtype" value="5" >Car<br />       
       </td>
   </tr>
   <tr><th>Count Years</th>
       <td id="count-year">
       {% for year in count_years %}
       <input type="checkbox" id="year{{year}}" name="count-year" value="year{{year}}" >{{year}}<br />       
       {% endfor %}
       </td>
   </tr>
   </table>
   
   <p>Movement locations: <span id="turn_count_num">{{ turn_count_locs|length }}</span></p>
   <p>Mainline locations: <span id="mainline_count_num">{{ mainline_count_locs|length }}</span></p>
   
   <input type="hidden" id="mainline_loc_ids" name="mainline_loc_ids" value="" />
   <input type="hidden" id="movement_loc_ids" name="movement_loc_ids" value="" />
   <input class="download" type="submit" name="download" value="Download" />
   <select name="download-type">
     <option value="mainlinelocs" title="Download all counts for the marked locations">All mainline counts</option>
     <option value="mainlinefilt" title="Download counts filtered by Vehicle Type and Count Year for the marked locations">Filtered mainline counts</option>
     <option value="movementlocs" title="Download all counts for the marked locations">All movement counts</option>
     <option value="movementfilt" title="Download counts filtered by Vehicle Type and Count Year for the marked locations">Filtered movement counts</option>
   </select>
  </form></div>
  <div id="map"></div>
  <div id="footer">This page is brought to you by <a href="https://github.com/sfcta/CountDracula">CountDracula</a> and <a href="http://geodjango.org/">GeoDjango</a>.</div>
</body>
</html>